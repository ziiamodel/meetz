<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Chat Panel</title>

  <style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #f2f7fc;
  color: #2a2a2a;
}

h2 {
  margin: 0;
  padding: 15px;
  background: #4aa3df;
  color: white;
  text-align: center;
  font-weight: 500;
  border-bottom: 2px solid #378ccc;
}

#loginPanel {
  padding: 20px;
  max-width: 400px;
  margin: 40px auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#loginPanel input,
#loginPanel button {
  padding: 12px;
  width: 100%;
  margin: 10px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
  font-size: 16px;
}

#loginPanel input {
  background: #f9fcff;
  color: #333;
}

#loginPanel button {
  background: #4aa3df;
  color: #ffffff;
  font-weight: bold;
  cursor: pointer;
  border: none;
  transition: background 0.3s;
}

#loginPanel button:hover {
  background: #378ccc;
}

.container {
  display: flex;
  height: 90vh;
}

.sidebar {
  width: 30%;
  background: #e3f0fb;
  overflow-y: auto;
  border-right: 2px solid #d0e2f2;
}

.fan {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  border-bottom: 1px solid #d0e2f2;
  cursor: pointer;
  transition: background 0.3s;
  position: relative;
}

.fan:hover {
  background: #d6e9f9;
}

.fan.active {
  background-color: #c6e2fa;
}

.fan.selected {
  background-color: #b3d7f7;
}

.fan.selected::after {
  content: "âœ“";
  position: absolute;
  right: 10px;
  color: #4aa3df;
  font-weight: bold;
}

.avatar {
  background: #4aa3df;
  color: #fff;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-weight: bold;
  font-size: 16px;
}

.fan-info {
  display: flex;
  align-items: center;
  flex: 1;
}

.dot {
  width: 10px;
  height: 10px;
  background: #f44336;
  border-radius: 50%;
  margin-left: 10px;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #f2f7fc;
}

.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.message {
  margin: 10px 0;
  padding: 12px 16px;
  border-radius: 12px;
  max-width: 70%;
  position: relative;
  font-size: 15px;
  line-height: 1.4;
}

.admin {
  background: #4aa3df;
  color: #ffffff;
  align-self: flex-end;
}

.fan-msg {
  background: #ffffff;
  color: #333;
  align-self: flex-start;
  border: 1px solid #d0e2f2;
}

.timestamp {
  font-size: 11px;
  color: #351414;
  margin-top: 5px;
  text-align: right;
}

.status {
  font-size: 12px;
  font-weight: bold;
  margin-top: 4px;
}

.status.seen {
  color: #4aa3df;
}

.chat-input {
  display: flex;
  border-top: 1px solid #d0e2f2;
  padding: 15px;
  background: #ffffff;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  background: #f9fcff;
  color: #333;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.chat-input button {
  margin-left: 12px;
  padding: 12px 20px;
  background: #4aa3df;
  color: #ffffff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
}

.chat-input button:hover {
  background: #378ccc;
}

#typingStatus {
  font-size: 13px;
  color: #666;
  margin: 8px 20px;
}

/* Bulk Message Panel */
.bulk-message-container {
  padding: 15px;
  background: white;
  border-top: 1px solid #d0e2f2;
}

.bulk-message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.bulk-message-header h3 {
  margin: 0;
  color: #4aa3df;
}

.bulk-message-controls {
  display: flex;
  gap: 10px;
}

.bulk-message-controls button {
  padding: 5px 10px;
  background: #4aa3df;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.bulk-message-controls button:hover {
  background: #378ccc;
}

.bulk-message-textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #d0e2f2;
  border-radius: 6px;
  min-height: 80px;
  margin-bottom: 10px;
  resize: vertical;
}

.selected-fans-container {
  margin-top: 10px;
}

.selected-fans-title {
  font-size: 12px;
  color: #666;
  margin-bottom: 5px;
}

.selected-fans-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

.selected-fan-tag {
  background: #e3f0fb;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  display: flex;
  align-items: center;
}

.selected-fan-tag button {
  background: none;
  border: none;
  color: #f44336;
  margin-left: 5px;
  cursor: pointer;
  padding: 0;
  font-weight: bold;
}

/* Suggestion Panel */
.suggestion-panel {
  padding: 15px;
  background: #fff;
  border-radius: 8px;
  margin: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  border: 1px solid #d0e2f2;
}

.suggestion-panel h3 {
  margin-top: 0;
  color: #4aa3df;
  text-align: center;
}

.suggestion-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
}

.suggestion-buttons button {
  padding: 8px;
  background: #ffebee;
  border: 1px solid #ffcdd2;
  border-radius: 6px;
  cursor: pointer;
  color: #d32f2f;
  transition: all 0.3s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.suggestion-buttons button:hover {
  background: #ef9a9a;
  color: white;
}

@media(max-width: 768px) {
  .container {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    height: 200px;
  }

  .chat-area {
    height: calc(100vh - 250px);
  }
  
  .suggestion-buttons {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>

<h2>ðŸ’¬ Admin Chat Panel</h2>

<div id="loginPanel">
  <h3 style="text-align:center;">Admin Login</h3>
  <input type="email" id="adminEmail" placeholder="Email">
  <input type="password" id="adminPassword" placeholder="Password">
  <button onclick="adminLogin()">Login</button>
  <p id="loginStatus" style="color: #f44336;"></p>
</div>

<div class="container" id="adminPanel" style="display:none;">
  <div class="sidebar" id="fanList"></div>
  <div class="chat-area">
    <div class="chat-box" id="chatBox"></div>
    
    <!-- Bulk Message Panel -->
    <div class="bulk-message-container">
      <div class="bulk-message-header">
        <h3>Bulk Message</h3>
        <div class="bulk-message-controls">
          <button onclick="clearSelectedFans()">Clear Selection</button>
          <button onclick="sendBulkMessage()">Send to Selected</button>
        </div>
      </div>
      <textarea class="bulk-message-textarea" id="bulkMessageText" placeholder="Type your message for selected fans..."></textarea>
      <div class="selected-fans-container">
        <div class="selected-fans-title">Selected Fans (<span id="selectedCount">0</span>):</div>
        <div class="selected-fans-list" id="selectedFansList"></div>
      </div>
    </div>
    
    <!-- Flirty Suggestions Panel -->
    <div class="suggestion-panel">
      <h3>Quick Messages</h3>
      <div class="suggestion-buttons">
        <button onclick="useSuggestion(1)">You're making me blush ðŸ˜Š</button>
        <button onclick="useSuggestion(2)">I can't stop thinking about you ðŸ’­</button>
        <button onclick="useSuggestion(3)">You're my favorite part of the day ðŸŒŸ</button>
        <button onclick="useSuggestion(4)">I'd love to get to know you better ðŸ˜‰</button>
        <button onclick="useSuggestion(5)">You have such beautiful energy âœ¨</button>
      </div>
    </div>
    
    <p id="typingStatus"></p>
    <div class="chat-input">
      <input type="text" id="adminMessage" placeholder="Type a message..." oninput="sendTypingStatus()" />
      <button onclick="sendAdminMessage()">Send</button>
    </div>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDWRfmNGsp3cBvD5mODOj1g7uOFbWXph-k",
    authDomain: "exclusivechat-64482.firebaseapp.com",
    projectId: "exclusivechat-64482",
    storageBucket: "exclusivechat-64482.appspot.com",
    messagingSenderId: "159353508205",
    appId: "1:159353508205:web:595954835fac71ef53ca64",
    databaseURL: "https://exclusivechat-64482-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  const adminUID = "yEDB99AJniWaOXfVwVex5qWMWiA2";

  let selectedFan = '';
  let activeChatRef = null;
  let typingTimeout;
  let selectedFans = new Set(); // Using Set to avoid duplicates

  function adminLogin() {
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;

    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        if (userCred.user.uid === adminUID) {
          document.getElementById('loginPanel').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'flex';
          loadFans();
        } else {
          document.getElementById('loginStatus').innerText = "Access denied: Not admin.";
          auth.signOut();
        }
      })
      .catch(error => {
        document.getElementById('loginStatus').innerText = "Login failed: " + error.message;
      });
  }

  auth.onAuthStateChanged(user => {
    if (user && user.uid === adminUID) {
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'flex';
      loadFans();
    }
  });

  function loadFans() {
    db.ref('users').on('value', snapshot => {
      document.getElementById('fanList').innerHTML = '';
      const users = snapshot.val();

      Object.keys(users).forEach(uid => {
        const fanName = users[uid].fanName;

        const fanDiv = document.createElement('div');
        fanDiv.className = 'fan';
        fanDiv.dataset.fanName = fanName;
        
        fanDiv.onclick = (e) => {
          // Check if Ctrl or Cmd key is pressed for multi-select
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            toggleFanSelection(fanName);
          } else {
            // Regular click - load chat
            loadFanChat(fanName);
          }
        };

        const infoDiv = document.createElement('div');
        infoDiv.className = 'fan-info';
        infoDiv.innerHTML = `
          <div class="avatar">${fanName.charAt(0).toUpperCase()}</div>
          <strong>${fanName}</strong>
        `;

        const dotDiv = document.createElement('div');
        dotDiv.id = `dot-${fanName}`;

        const typingDiv = document.createElement('div');
        typingDiv.id = `typing-${fanName}`;
        typingDiv.style.fontSize = '12px';
        typingDiv.style.color = 'gray';

        fanDiv.appendChild(infoDiv);
        fanDiv.appendChild(dotDiv);
        fanDiv.appendChild(typingDiv);
        document.getElementById('fanList').appendChild(fanDiv);

        // Fix closure issue by using let-scoped copy
        const fanNameCopy = fanName;

        // Listen for unread messages
        db.ref(`chats/${fanNameCopy}`).on('value', chatSnap => {
          let showDot = false;
          chatSnap.forEach(msg => {
            const val = msg.val();
            if (val.sender !== 'admin' && val.status !== 'seen') {
              showDot = true;
            }
          });
          const dotElement = document.getElementById(`dot-${fanNameCopy}`);
          if (dotElement) {
            dotElement.innerHTML = showDot ? '<div class="dot"></div>' : '';
          }
        });

        // Typing indicator
        db.ref(`chats/${fanNameCopy}/typingStatus/fan`).on('value', typingSnap => {
          const typingStatus = typingSnap.val();
          const typingIndicator = document.getElementById(`typing-${fanNameCopy}`);
          if (typingIndicator) {
            typingIndicator.innerText = typingStatus === 'typing' ? 'Typing...' : '';
          }
        });
      });
    });
  }

  function toggleFanSelection(fanName) {
    const fanDiv = document.querySelector(`.fan[data-fan-name="${fanName}"]`);
    
    if (selectedFans.has(fanName)) {
      // Remove from selection
      selectedFans.delete(fanName);
      fanDiv.classList.remove('selected');
    } else {
      // Add to selection
      selectedFans.add(fanName);
      fanDiv.classList.add('selected');
    }
    
    updateSelectedFansDisplay();
  }

  function clearSelectedFans() {
    selectedFans.forEach(fanName => {
      const fanDiv = document.querySelector(`.fan[data-fan-name="${fanName}"]`);
      if (fanDiv) fanDiv.classList.remove('selected');
    });
    selectedFans.clear();
    updateSelectedFansDisplay();
  }

  function updateSelectedFansDisplay() {
    const container = document.getElementById('selectedFansList');
    const countElement = document.getElementById('selectedCount');
    
    container.innerHTML = '';
    countElement.textContent = selectedFans.size;
    
    selectedFans.forEach(fanName => {
      const tag = document.createElement('div');
      tag.className = 'selected-fan-tag';
      tag.innerHTML = `
        ${fanName}
        <button onclick="removeSelectedFan('${fanName}')">Ã—</button>
      `;
      container.appendChild(tag);
    });
  }

  function removeSelectedFan(fanName) {
    if (selectedFans.has(fanName)) {
      selectedFans.delete(fanName);
      const fanDiv = document.querySelector(`.fan[data-fan-name="${fanName}"]`);
      if (fanDiv) fanDiv.classList.remove('selected');
      updateSelectedFansDisplay();
    }
  }

  function loadFanChat(fanName) {
    selectedFan = fanName;
    clearSelectedFans();

    if (activeChatRef) activeChatRef.off();
    activeChatRef = db.ref(`chats/${fanName}`);

    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';

    activeChatRef.on('child_added', snapshot => {
      const data = snapshot.val();
      const key = snapshot.key;
      if (key === "typingStatus") return;
      if (data && data.text && data.timestamp) {
        displayMessage(data.text, data.sender, data.timestamp, data.status);
      }
    });

    activeChatRef.on('value', snap => {
      chatBox.innerHTML = '';
      const messages = snap.val();

      for (let id in messages) {
        const msg = messages[id];
        if (id === 'typingStatus') continue;

        const div = document.createElement('div');
        div.className = 'message ' + (msg.sender === 'admin' ? 'admin' : 'fan-msg');

        const msgDate = new Date(msg.timestamp || 0);
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);

        let dateString = '';
        if (msgDate.toDateString() === today.toDateString()) {
          dateString = 'Today';
        } else if (msgDate.toDateString() === yesterday.toDateString()) {
          dateString = 'Yesterday';
        } else {
          dateString = msgDate.toLocaleDateString();
        }

        const timeString = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        div.innerHTML = `
          ${msg.text || 'undefined'}
          <div class="timestamp">${dateString}, ${timeString}</div>
        `;

        if (msg.status === 'seen') {
          const statusDiv = document.createElement('div');
          statusDiv.classList.add('status', 'seen');
          statusDiv.innerText = 'âœ“âœ“';
          div.appendChild(statusDiv);
        }

        chatBox.appendChild(div);
      }

      chatBox.scrollTop = chatBox.scrollHeight;

      snap.forEach(childSnap => {
        const id = childSnap.key;
        const val = childSnap.val();
        if (id !== 'typingStatus' && val.sender !== 'admin' && val.status !== 'seen') {
          db.ref(`chats/${fanName}/${id}`).update({ status: 'seen' });
        }
      });

      // Highlight active fan
      document.querySelectorAll('.fan').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.fan').forEach(el => {
        if (el.dataset.fanName === fanName) el.classList.add('active');
      });
    });
  }

  function sendAdminMessage() {
    const msg = document.getElementById('adminMessage').value.trim();
    if (!msg || !selectedFan) return;

    db.ref(`chats/${selectedFan}`).push({
      sender: 'admin',
      text: msg,
      timestamp: Date.now(),
      status: 'sent'
    });

    document.getElementById('adminMessage').value = '';
  }

  function sendBulkMessage() {
    const msg = document.getElementById('bulkMessageText').value.trim();
    if (!msg || selectedFans.size === 0) {
      alert('Please select fans and type a message');
      return;
    }

    // Confirm before sending
    if (!confirm(`Send this message to ${selectedFans.size} fans?`)) {
      return;
    }

    let sentCount = 0;
    selectedFans.forEach(fanName => {
      db.ref(`chats/${fanName}`).push({
        sender: 'admin',
        text: msg,
        timestamp: Date.now(),
        status: 'sent'
      }).then(() => {
        sentCount++;
        if (sentCount === selectedFans.size) {
          alert(`Message sent to ${sentCount} fans successfully!`);
          document.getElementById('bulkMessageText').value = '';
          clearSelectedFans();
        }
      });
    });
  }

  function useSuggestion(index) {
    const suggestions = [
      "You're making me blush ðŸ˜Š",
      "I can't stop thinking about you ðŸ’­",
      "You're my favorite part of the day ðŸŒŸ",
      "I'd love to get to know you better ðŸ˜‰",
      "You have such beautiful energy âœ¨"
    ];
    
    if (selectedFans.size > 0) {
      // If in bulk mode, add to bulk message
      const bulkTextarea = document.getElementById('bulkMessageText');
      bulkTextarea.value = suggestions[index - 1];
    } else if (selectedFan) {
      // If in single chat mode, send directly
      document.getElementById('adminMessage').value = suggestions[index - 1];
    }
  }

  function sendTypingStatus() {
    if (!selectedFan) return;

    db.ref(`chats/${selectedFan}/typingStatus/admin`).set('typing');

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      db.ref(`chats/${selectedFan}/typingStatus/admin`).set('');
    }, 2000);
  }

  function displayMessage(text, sender, timestamp, status) {
    const chatBox = document.getElementById('chatBox');
    const div = document.createElement('div');
    div.className = 'message ' + (sender === 'admin' ? 'admin' : 'fan-msg');

    const msgDate = new Date(timestamp || 0);
    const timeString = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    let dateString = '';
    if (msgDate.toDateString() === today.toDateString()) {
      dateString = 'Today';
    } else if (msgDate.toDateString() === yesterday.toDateString()) {
      dateString = 'Yesterday';
    } else {
      dateString = msgDate.toLocaleDateString();
    }

    div.innerHTML = `
      ${text || 'undefined'}
      <div class="timestamp">${dateString}, ${timeString}</div>
    `;

    if (status === 'seen') {
      const statusDiv = document.createElement('div');
      statusDiv.classList.add('status', 'seen');
      statusDiv.innerText = 'âœ“âœ“';
      div.appendChild(statusDiv);
    }

    chatBox.appendChild(div);
  }
</script>

</body>
</html>
